{
  "success": true,
  "next_box": "CONDUCTOR",
  "context": {
    "project_type": "web_app",
    "project_subtype": "fullstack_monorepo",
    "description_detail": "Decentralized book marketplace with multi-brand storefront, dual-mode payments (Stripe primary + crypto fallback), federation network for cross-node discovery, pluggable auth (local magic links + Teneo OAuth SSO), published book tracking with Amazon integration, course platform module, funnel builder module, and censorship-resistant architecture. Public open-source repo — content generation lives in a separate private repo (teneo-production).",
    "tech_stack": {
      "languages": ["JavaScript (Node.js)", "SQL (SQLite)", "HTML", "CSS"],
      "runtime": "Node.js 18+",
      "frameworks": ["Express.js 4.x"],
      "frontend_framework": "None (vanilla HTML/CSS/JS — no React/Vue/Angular)",
      "database": "SQLite3 (via sqlite3 npm package)",
      "payment": ["Stripe (primary)", "Bitcoin/Lightning/Monero (crypto fallback)"],
      "email": "Nodemailer",
      "print_on_demand": "Lulu API",
      "auth": ["Local (SQLite + magic links)", "Teneo Auth (OAuth 2.0 SSO)"],
      "build_tools": ["npm", "Docker", "Docker Compose"],
      "test_framework": "None configured (package.json has echo Error stub)",
      "package_manager": "npm",
      "containerization": "Docker (node:18-alpine) + nginx + redis + postgres (optional)",
      "ci_cd": "None detected"
    },
    "dependencies": {
      "declared_in_package_json": [
        "archiver@^6.0.1",
        "axios@^1.6.0",
        "cors@^2.8.5",
        "csv-parse@^5.6.0",
        "dotenv@^16.3.1",
        "express@^4.18.2",
        "multer@^1.4.5-lts.1",
        "nodemailer@^6.9.0",
        "sqlite3@^5.1.6",
        "stripe@^14.5.0"
      ],
      "dev_dependencies": ["nodemon@^3.0.2"],
      "used_but_not_in_package_json": [
        "bcrypt (used in server.js and middleware/auth.js)",
        "express-session (used in server.js)",
        "csurf (used in server.js)",
        "express-rate-limit (used in middleware/auth.js)",
        "body-parser (used in server.js — note: express has built-in body parsing)"
      ]
    },
    "structure": {
      "entry_points": ["marketplace/backend/server.js"],
      "key_directories": [
        "marketplace/backend/routes/ — 26 route files (checkout, auth, admin, brands, network, crypto, nft, etc.)",
        "marketplace/backend/services/ — 20+ service files (order, email, lulu, analytics, AI discovery, etc.)",
        "marketplace/backend/database/ — SQLite schema, init, database connection",
        "marketplace/backend/auth/ — Pluggable auth providers (AuthProvider base class, Local + Teneo providers)",
        "marketplace/backend/middleware/ — Auth middleware (admin auth, rate limiting, HTTPS enforcement)",
        "marketplace/backend/scripts/ — Utility scripts (create-real-data, generate-password-hash, etc.)",
        "marketplace/backend/config/ — Network configuration",
        "marketplace/frontend/ — 30 HTML pages, vanilla JS, CSS",
        "marketplace/frontend/brands/ — Multi-brand system (config.json + catalog.json per brand)",
        "marketplace/frontend/js/ — 23 frontend JS files",
        "marketplace/frontend/components-library/ — Reusable HTML components (heroes, CTAs, forms, pricing, etc.)",
        "course-module/ — Standalone course platform (config, courses, lessons)",
        "funnel-module/ — Standalone funnel builder (backend routes, frontend builder)",
        "setup-wizard/ — Initial setup wizard HTML",
        "docs/ — 75+ markdown documentation files organized by category",
        "deploy/ — Deployment configs",
        "nginx/ — Nginx reverse proxy config",
        "scripts/ — Root-level utility scripts",
        "tools/ — Additional tooling"
      ],
      "config_files": [
        "package.json",
        ".env.example (comprehensive — 196 lines)",
        "marketplace/backend/.env.example",
        "Dockerfile",
        "Dockerfile.dev",
        "docker-compose.yml",
        "docker-compose.dev.yml",
        ".gitignore",
        ".dockerignore",
        "CLAUDE.md"
      ],
      "brand_system": {
        "description": "Multi-brand architecture where each brand gets its own directory under marketplace/frontend/brands/ with config.json (brand settings) and catalog.json (book catalog). Brands include: teneo, information_asymmetry, quantum_youth_publishing, true-earth, wealth-wise, my-test-brand, test_automation_brand, master-templates (base template).",
        "brands_found": ["teneo", "information_asymmetry", "quantum_youth_publishing", "true-earth", "wealth-wise", "my-test-brand", "test_automation_brand", "default", "master-templates"]
      }
    },
    "api_routes": {
      "prefix": "/api",
      "route_mounts": [
        "/api/brands — brandRoutes",
        "/api/checkout — checkoutRoutes (production vs dev variants)",
        "/api/crypto — cryptoCheckoutRoutes",
        "/api/catalog — catalogRoutes",
        "/api/download — downloadRoutes",
        "/api/lulu — luluAdminRoutes",
        "/api/admin — adminRoutes",
        "/api/network — networkRoutes",
        "/api/config — configRoutes",
        "/api/published — publishedBooksRoutes",
        "/api/publishers — publisherProfileRoutes",
        "/api/books — bookAnalyticsRoutes (+ inline /api/books GET)",
        "/api/digest — digestRoutes",
        "/api/manual-enhancement — manualEnhancementRoutes",
        "/api/discovery — aiDiscoveryRoutes",
        "/api/censorship — censorshipTrackerRoutes",
        "/api/nft — nftRoutes",
        "/api/funnels — funnelRoutes",
        "/webhooks — webhookRoutes",
        "/api/health — inline health check",
        "/api/search — inline search endpoint",
        "/api/csrf-token — inline CSRF token endpoint",
        "/api/auth — auth routes (registered in auth routes file)"
      ],
      "note": "Auth routes (/api/auth/*) are imported in auth/config.js but NOT mounted in server.js — potential bug"
    },
    "database_schema": {
      "tables": [
        "orders — Core order tracking (Stripe sessions, fulfillment, downloads)",
        "download_logs — Download attempt logging",
        "payment_events — Stripe webhook event history",
        "refunds — Refund records",
        "email_logs — Email send logging",
        "published_books — Amazon-published book tracking with rankings/reviews",
        "book_ranking_history — Historical BSR tracking",
        "teneo_auth_tokens — OAuth token storage",
        "publication_milestones — Community milestone goals",
        "cron_execution_log — Scheduled job tracking",
        "book_amazon_data — Enhanced Amazon product data",
        "book_category_rankings — Category rank tracking",
        "book_price_history — Price change tracking",
        "book_publisher_notes — Publisher notes/tips per book",
        "performance_alerts — User performance notifications",
        "daily_performance_digest — Daily summary cache",
        "book_insights — AI-generated book insights",
        "publisher_stats — Publisher profile/stats",
        "publisher_milestones — Per-publisher milestone tracking",
        "leaderboard_cache — Cached leaderboard rankings",
        "publisher_rewards — Earned rewards tracking",
        "books — Book metadata (created in database.js init)",
        "book_formats — Print format variants (Lulu integration)"
      ]
    },
    "build_command": "npm start (production) or npm run dev (development with nodemon)",
    "test_command": "None — npm test echoes error. No test framework installed.",
    "init_command": "node marketplace/backend/database/init.js",
    "documentation": {
      "has_readme": true,
      "has_claude_md": true,
      "has_contributing": true,
      "has_api_docs": true,
      "has_architecture_docs": true,
      "planning_docs": ["OVERNIGHT_TASKS.md", "docs/reference/IMPLEMENTATION_PLAN.md", "docs/reference/MARKETPLACE_STATUS_AND_TODO.md", "docs/features/REVOLUTIONARY_FEATURES_ROADMAP.md", "docs/features/AMAZON_FEATURES_ROADMAP.md"],
      "security_docs": ["docs/reference/SECURITY.md", "docs/reference/SECURITY_AUDIT_REPORT.md", "docs/reference/SECURITY_SETUP_GUIDE.md"],
      "deployment_docs": ["docs/deployment/DEPLOYMENT_GUIDE.md", "docs/deployment/RENDER_DEPLOYMENT.md", "docs/deployment/DOCKER_DEPLOYMENT.md", "docs/deployment/PRODUCTION_SETUP.md"],
      "doc_categories": ["core", "deployment", "development", "features", "integration", "quick-start", "reference"],
      "total_doc_files": "75+"
    },
    "coding_conventions": {
      "module_system": "CommonJS (require/module.exports) throughout",
      "naming_style": "camelCase for variables/functions, PascalCase for classes (OrderService, EmailService, AuthProvider, CronJobService)",
      "variable_naming": "camelCase (orderId, bookTitle, searchTerm, brandsPath)",
      "file_naming": "camelCase for route/service files (adminRoutes.js, orderService.js), kebab-case for some (email-service.js, database-service.js, network-service.js)",
      "error_handling": "try/catch with console.error() logging. Routes return JSON: { success: false, error: 'message', message: error.message } or { error: 'message' }. Status codes used consistently (400, 401, 404, 500).",
      "response_format": "JSON responses with { success: true, data: ... } pattern for success, { success: false, error: '...' } or { error: '...' } for errors. Not 100% consistent — some routes use success field, some don't.",
      "import_style": "require() at file top. Order: dotenv first, then stdlib (path, fs, crypto), then npm packages (express, cors, stripe), then local modules (routes, services, middleware). No consistent grouping comments.",
      "route_pattern": "express.Router() per domain file, mounted at /api/* prefix in server.js. Routes use async handlers with try/catch.",
      "service_pattern": "Class-based services with async methods. SQLite callbacks wrapped in new Promise(). Constructor creates own DB connection (not shared — potential issue).",
      "auth_pattern": "Abstract AuthProvider base class with concrete LocalAuthProvider and TeneoAuthProvider implementations. Pluggable via AUTH_PROVIDER env var.",
      "database_pattern": "Raw SQL queries with parameterized statements (? placeholders). No ORM. Each service opens its own sqlite3 connection.",
      "test_framework": "None",
      "test_location": "No test directory. Root has ad-hoc test scripts: test-api.js, test-purchase-flow.js, test-purchase-direct.js, test-stripe-key.js, test-webhooks.js",
      "key_utilities": [
        "marketplace/backend/database/database.js — Shared SQLite connection (module.exports = db)",
        "marketplace/backend/services/orderService.js — OrderService class for all order CRUD operations",
        "marketplace/backend/services/emailService.js — EmailService class for sending emails via Nodemailer",
        "marketplace/backend/middleware/auth.js — authenticateAdmin(), loginLimiter, verifyPassword(), requireHTTPS()",
        "marketplace/backend/auth/AuthProvider.js — Abstract base class for pluggable auth",
        "marketplace/backend/auth/config.js — getAuthProviderInstance() factory",
        "marketplace/backend/services/auditService.js — Admin action audit logging",
        "marketplace/backend/services/cronJobs.js — CronJobService for scheduled tasks"
      ]
    },
    "current_state": {
      "working": [
        "Express server structure with 20+ API route mounts",
        "Database schema (comprehensive — 23+ tables defined in schema.sql)",
        "Stripe checkout session creation and webhook handler",
        "Auth routes (register, login, magic link, OAuth callback, verify, logout)",
        "Auth provider abstraction (Local + Teneo providers)",
        "Admin authentication middleware with rate limiting and audit logging",
        "Brand/catalog system (multi-brand with JSON configs)",
        "Book search and listing endpoints",
        "CSRF protection with exclusions for webhooks",
        "Session management with secure cookie config",
        "HTTPS enforcement in production",
        "Health check endpoint",
        "Docker and Docker Compose configuration",
        "Extensive documentation (75+ docs)"
      ],
      "broken": [
        "Missing npm dependencies — bcrypt, express-session, csurf, express-rate-limit, body-parser are required in code but NOT listed in package.json. Server will crash on startup.",
        "Auth routes (/api/auth/*) appear not to be mounted in server.js — auth routes file exists but no app.use('/api/auth', authRoutes) line in server.js",
        "No .env file — only .env.example exists. Server needs environment variables to start.",
        "OrderService creates its own sqlite3 connection per instance rather than using shared database.js connection — potential multi-connection issues",
        "body-parser is used but express 4.x has built-in json/urlencoded parsing (minor, would still work if installed)"
      ],
      "incomplete": [
        "No test suite — package.json test script is a stub",
        "No login/register frontend UI — backend auth routes exist but no HTML pages for users",
        "Email service needs SMTP credentials to function",
        "Course module exists but not fully integrated into marketplace purchase flow",
        "Funnel module minimally integrated (routes imported, but standalone UI)",
        "Federation network — routes exist but no cross-node testing or real peering",
        "NFT/Proof-of-Read — routes exist, likely skeleton implementation",
        "AI Discovery engine — service exists, unclear if functional",
        "Censorship tracker — routes and service exist, unclear completion level",
        "No OpenAPI/Swagger documentation for the 26+ API routes",
        "Docker deployment untested according to OVERNIGHT_TASKS.md"
      ],
      "test_coverage": "none",
      "dependency_health": "broken — missing 5 required packages from package.json"
    },
    "security_notes": [
      "CSRF protection implemented via csurf (good, but package deprecated)",
      "Rate limiting on admin login (5 attempts per 15 min)",
      "bcrypt for password hashing",
      "Secure cookie config (httpOnly, sameSite strict, secure in production)",
      "HTTPS enforcement in production",
      "Audit trail for admin actions",
      "Download tokens with 24-hour expiry",
      "Default admin password in code — OVERNIGHT_TASKS.md warns to change it",
      ".env.example contains a TENEO_CLIENT_SECRET value (documented as intentional for the example file)"
    ],
    "summary": "Teneo Marketplace is an ambitious fullstack Node.js/Express web application serving as a decentralized book marketplace with multi-brand storefronts, Stripe payments with crypto fallback, pluggable auth (magic links + OAuth SSO), Amazon book tracking, course platform, and funnel builder. The backend architecture is substantial (26 route files, 20+ services, 23+ database tables) but has critical startup blockers: 5 npm packages used in code are missing from package.json, no test suite exists, and no frontend auth UI is built. The project has extensive documentation (75+ docs) and well-structured code but needs dependency fixes, test infrastructure, and frontend auth pages before it can run."
  }
}
