<!-- Lesson Content Component
     Content wrapper for course lessons with proper formatting
     Reusable across traviseric.com and teneo-marketplace -->

<style>
.lesson-content {
  max-width: 800px;
  margin: 0 auto;
  padding: var(--spacing-xl);
  background: var(--brand-bg);
}

.lesson-content__header {
  margin-bottom: var(--spacing-2xl);
  padding-bottom: var(--spacing-xl);
  border-bottom: 2px solid var(--brand-border-light);
}

.lesson-content__breadcrumb {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-lg);
  font-size: var(--font-size-sm);
  color: var(--brand-text-secondary);
}

.lesson-content__breadcrumb-link {
  color: var(--brand-accent);
  text-decoration: none;
  transition: color 0.2s ease;
}

.lesson-content__breadcrumb-link:hover {
  color: var(--brand-primary);
  text-decoration: underline;
}

.lesson-content__breadcrumb-separator {
  color: var(--brand-text-muted);
}

.lesson-content__title {
  font-family: var(--brand-font-heading);
  font-size: var(--font-size-4xl);
  font-weight: 700;
  color: var(--brand-text);
  line-height: 1.2;
  margin-bottom: var(--spacing-md);
}

.lesson-content__meta {
  display: flex;
  align-items: center;
  gap: var(--spacing-lg);
  flex-wrap: wrap;
  font-size: var(--font-size-sm);
  color: var(--brand-text-secondary);
}

.lesson-content__meta-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.lesson-content__meta-icon {
  font-size: var(--font-size-base);
}

.lesson-content__body {
  font-family: var(--brand-font-main);
  font-size: var(--font-size-lg);
  line-height: 1.7;
  color: var(--brand-text);
}

/* Typography styles for content */
.lesson-content__body h2 {
  font-family: var(--brand-font-heading);
  font-size: var(--font-size-2xl);
  font-weight: 700;
  color: var(--brand-text);
  margin-top: var(--spacing-2xl);
  margin-bottom: var(--spacing-lg);
  line-height: 1.3;
}

.lesson-content__body h3 {
  font-family: var(--brand-font-heading);
  font-size: var(--font-size-xl);
  font-weight: 600;
  color: var(--brand-text);
  margin-top: var(--spacing-xl);
  margin-bottom: var(--spacing-md);
  line-height: 1.4;
}

.lesson-content__body p {
  margin-bottom: var(--spacing-lg);
}

.lesson-content__body ul,
.lesson-content__body ol {
  margin-bottom: var(--spacing-lg);
  padding-left: var(--spacing-xl);
}

.lesson-content__body li {
  margin-bottom: var(--spacing-sm);
}

.lesson-content__body strong {
  font-weight: 600;
  color: var(--brand-text);
}

.lesson-content__body em {
  font-style: italic;
}

.lesson-content__body a {
  color: var(--brand-accent);
  text-decoration: underline;
  transition: color 0.2s ease;
}

.lesson-content__body a:hover {
  color: var(--brand-primary);
}

.lesson-content__body blockquote {
  margin: var(--spacing-xl) 0;
  padding: var(--spacing-lg) var(--spacing-xl);
  background: var(--brand-bg-secondary);
  border-left: 4px solid var(--brand-accent);
  border-radius: var(--border-radius-md);
  font-style: italic;
  color: var(--brand-text-secondary);
}

.lesson-content__body code {
  font-family: 'Monaco', 'Courier New', monospace;
  font-size: 0.9em;
  padding: 2px 6px;
  background: var(--brand-bg-secondary);
  border-radius: var(--border-radius-sm);
  color: var(--brand-accent);
}

.lesson-content__body pre {
  margin: var(--spacing-lg) 0;
  padding: var(--spacing-lg);
  background: var(--brand-bg-secondary);
  border-radius: var(--border-radius-md);
  overflow-x: auto;
  border: 1px solid var(--brand-border-light);
}

.lesson-content__body pre code {
  padding: 0;
  background: none;
  color: var(--brand-text);
  font-size: var(--font-size-sm);
  line-height: 1.5;
}

.lesson-content__body img,
.lesson-content__body video {
  max-width: 100%;
  height: auto;
  border-radius: var(--border-radius-md);
  margin: var(--spacing-xl) 0;
  box-shadow: var(--shadow-md);
}

.lesson-content__callout {
  margin: var(--spacing-xl) 0;
  padding: var(--spacing-lg);
  background: var(--brand-bg-secondary);
  border-radius: var(--border-radius-lg);
  border-left: 4px solid var(--brand-accent);
}

.lesson-content__callout--info {
  border-left-color: #3b82f6;
  background: rgba(59, 130, 246, 0.05);
}

.lesson-content__callout--warning {
  border-left-color: #f59e0b;
  background: rgba(245, 158, 11, 0.05);
}

.lesson-content__callout--success {
  border-left-color: var(--brand-success);
  background: rgba(16, 185, 129, 0.05);
}

.lesson-content__callout--error {
  border-left-color: #ef4444;
  background: rgba(239, 68, 68, 0.05);
}

.lesson-content__callout-title {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  font-weight: 600;
  color: var(--brand-text);
  margin-bottom: var(--spacing-sm);
  font-size: var(--font-size-base);
}

.lesson-content__callout-content {
  color: var(--brand-text-secondary);
  font-size: var(--font-size-base);
  line-height: 1.6;
}

.lesson-content__footer {
  margin-top: var(--spacing-2xl);
  padding-top: var(--spacing-xl);
  border-top: 2px solid var(--brand-border-light);
}

.lesson-content__actions {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-xl);
}

.lesson-content__action-btn {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md) var(--spacing-lg);
  background: var(--brand-bg-secondary);
  color: var(--brand-text);
  border: 1px solid var(--brand-border-light);
  border-radius: var(--border-radius-md);
  font-family: var(--brand-font-main);
  font-size: var(--font-size-base);
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

.lesson-content__action-btn:hover {
  background: var(--brand-bg-tertiary);
  border-color: var(--brand-accent);
  transform: translateY(-1px);
}

.lesson-content__action-btn--primary {
  background: var(--brand-accent);
  color: white;
  border-color: var(--brand-accent);
}

.lesson-content__action-btn--primary:hover {
  background: var(--brand-primary);
  border-color: var(--brand-primary);
}

.lesson-content__complete-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
  width: 100%;
  padding: var(--spacing-lg);
  background: var(--brand-success);
  color: white;
  border: none;
  border-radius: var(--border-radius-md);
  font-family: var(--brand-font-main);
  font-size: var(--font-size-lg);
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
}

.lesson-content__complete-btn:hover {
  background: var(--brand-primary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.lesson-content__complete-btn--completed {
  background: var(--brand-bg-secondary);
  color: var(--brand-text-secondary);
  cursor: default;
}

.lesson-content__complete-btn--completed:hover {
  transform: none;
  box-shadow: none;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .lesson-content {
    padding: var(--spacing-lg);
  }

  .lesson-content__title {
    font-size: var(--font-size-2xl);
  }

  .lesson-content__body {
    font-size: var(--font-size-base);
  }

  .lesson-content__body h2 {
    font-size: var(--font-size-xl);
  }

  .lesson-content__body h3 {
    font-size: var(--font-size-lg);
  }

  .lesson-content__actions {
    flex-direction: column;
  }

  .lesson-content__action-btn {
    width: 100%;
    justify-content: center;
  }
}
</style>

<article class="lesson-content"
         data-course-slug="{{COURSE_SLUG}}"
         data-module-slug="{{MODULE_SLUG}}"
         data-lesson-slug="{{LESSON_SLUG}}">

  <header class="lesson-content__header">
    <!-- Breadcrumb navigation -->
    <nav class="lesson-content__breadcrumb" aria-label="Breadcrumb">
      <a href="/courses/{{COURSE_SLUG}}" class="lesson-content__breadcrumb-link">{{COURSE_TITLE}}</a>
      <span class="lesson-content__breadcrumb-separator">‚Ä∫</span>
      <a href="/courses/{{COURSE_SLUG}}/{{MODULE_SLUG}}" class="lesson-content__breadcrumb-link">{{MODULE_TITLE}}</a>
      <span class="lesson-content__breadcrumb-separator">‚Ä∫</span>
      <span>{{LESSON_TITLE}}</span>
    </nav>

    <!-- Lesson title -->
    <h1 class="lesson-content__title">{{LESSON_TITLE}}</h1>

    <!-- Meta information -->
    <div class="lesson-content__meta">
      <div class="lesson-content__meta-item">
        <span class="lesson-content__meta-icon">‚è±</span>
        <span>{{DURATION|15 min}}</span>
      </div>
      <div class="lesson-content__meta-item">
        <span class="lesson-content__meta-icon">üìù</span>
        <span>Lesson {{LESSON_NUMBER}}</span>
      </div>
      {{#IF_VIDEO}}
      <div class="lesson-content__meta-item">
        <span class="lesson-content__meta-icon">üé•</span>
        <span>Video + Transcript</span>
      </div>
      {{/IF_VIDEO}}
    </div>
  </header>

  <!-- Main lesson content -->
  <div class="lesson-content__body" id="lessonBody">
    {{LESSON_CONTENT}}
  </div>

  <footer class="lesson-content__footer">
    <!-- Navigation actions -->
    <div class="lesson-content__actions">
      <a href="{{PREV_LESSON_URL}}" class="lesson-content__action-btn" id="prevLessonBtn">
        ‚Üê Previous Lesson
      </a>
      <a href="{{NEXT_LESSON_URL}}" class="lesson-content__action-btn lesson-content__action-btn--primary" id="nextLessonBtn">
        Next Lesson ‚Üí
      </a>
    </div>

    <!-- Mark as complete button -->
    <button class="lesson-content__complete-btn" id="markCompleteBtn">
      <span id="completeIcon">‚úì</span>
      <span id="completeText">Mark as Complete</span>
    </button>
  </footer>
</article>

<script>
(function() {
  'use strict';

  const lessonContent = document.querySelector('.lesson-content');
  const courseSlug = lessonContent.dataset.courseSlug;
  const moduleSlug = lessonContent.dataset.moduleSlug;
  const lessonSlug = lessonContent.dataset.lessonSlug;
  const markCompleteBtn = document.getElementById('markCompleteBtn');
  const completeIcon = document.getElementById('completeIcon');
  const completeText = document.getElementById('completeText');
  const prevLessonBtn = document.getElementById('prevLessonBtn');
  const nextLessonBtn = document.getElementById('nextLessonBtn');

  let isCompleted = false;

  // Load lesson completion status
  async function loadCompletionStatus() {
    try {
      const response = await fetch(`/api/course/lesson-status?course=${courseSlug}&module=${moduleSlug}&lesson=${lessonSlug}`);
      if (response.ok) {
        const data = await response.json();
        if (data.completed) {
          markAsCompleted(false); // Don't trigger API call
        }
      }
    } catch (error) {
      console.error('Failed to load completion status:', error);
      loadFromLocalStorage();
    }
  }

  function loadFromLocalStorage() {
    const key = `lesson_complete_${courseSlug}_${moduleSlug}_${lessonSlug}`;
    const completed = localStorage.getItem(key) === 'true';
    if (completed) {
      markAsCompleted(false);
    }
  }

  // Mark lesson as complete
  async function markAsComplete() {
    if (isCompleted) return;

    try {
      const response = await fetch('/api/course/mark-complete', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          courseSlug,
          moduleSlug,
          lessonSlug
        })
      });

      if (response.ok) {
        markAsCompleted(true);

        // Track analytics
        if (window.trackAnalytics) {
          window.trackAnalytics('lesson_complete', {
            course_slug: courseSlug,
            module_slug: moduleSlug,
            lesson_slug: lessonSlug
          });
        }

        // Update course progress
        const data = await response.json();
        if (data.overallProgress && window.updateCourseProgress) {
          window.updateCourseProgress(data);
        }

        // Dispatch event for other components
        window.dispatchEvent(new CustomEvent('lessonComplete', {
          detail: {
            courseSlug,
            moduleSlug,
            lessonSlug,
            progress: data.overallProgress
          }
        }));
      }
    } catch (error) {
      console.error('Failed to mark lesson complete:', error);
      // Save to localStorage as fallback
      const key = `lesson_complete_${courseSlug}_${moduleSlug}_${lessonSlug}`;
      localStorage.setItem(key, 'true');
      markAsCompleted(false);
    }
  }

  function markAsCompleted(animate = true) {
    isCompleted = true;
    markCompleteBtn.classList.add('lesson-content__complete-btn--completed');
    completeIcon.textContent = '‚úì';
    completeText.textContent = 'Completed';

    if (animate) {
      // Celebration animation
      markCompleteBtn.style.transform = 'scale(1.05)';
      setTimeout(() => {
        markCompleteBtn.style.transform = '';
      }, 200);

      // Show confetti or success message
      showSuccessMessage();
    }
  }

  function showSuccessMessage() {
    // Create temporary success message
    const message = document.createElement('div');
    message.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--brand-success);
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      font-weight: 600;
      z-index: 10000;
      animation: slideInRight 0.3s ease;
    `;
    message.textContent = 'üéâ Lesson Complete!';
    document.body.appendChild(message);

    setTimeout(() => {
      message.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => message.remove(), 300);
    }, 3000);
  }

  // Handle complete button click
  markCompleteBtn.addEventListener('click', function() {
    if (!isCompleted) {
      markAsComplete();
    }
  });

  // Track reading progress (auto-complete when scrolled to bottom)
  let hasScrolledToBottom = false;
  function trackScrollProgress() {
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

    // If scrolled to within 100px of bottom
    if (scrollTop + windowHeight >= documentHeight - 100 && !hasScrolledToBottom) {
      hasScrolledToBottom = true;

      // Auto-highlight complete button
      if (!isCompleted) {
        markCompleteBtn.style.animation = 'pulse 2s infinite';
      }
    }
  }

  window.addEventListener('scroll', trackScrollProgress);

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Left arrow - previous lesson
    if (e.key === 'ArrowLeft' && prevLessonBtn && !e.metaKey && !e.ctrlKey) {
      window.location.href = prevLessonBtn.href;
    }
    // Right arrow - next lesson
    if (e.key === 'ArrowRight' && nextLessonBtn && !e.metaKey && !e.ctrlKey) {
      window.location.href = nextLessonBtn.href;
    }
    // C - mark complete
    if (e.key === 'c' && !e.metaKey && !e.ctrlKey && !isCompleted) {
      markAsComplete();
    }
  });

  // Initialize
  loadCompletionStatus();
})();
</script>

<!-- Add CSS animations -->
<style>
@keyframes pulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
  }
  50% {
    box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
  }
}

@keyframes slideInRight {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}
</style>
