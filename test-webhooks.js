/**
 * Test Script for Orchestrator Webhooks
 *
 * Tests all three webhook endpoints:
 * 1. Brand Created
 * 2. Book Generated
 * 3. SEO Content Generated
 */

const BASE_URL = 'http://localhost:3001';

// Test data
const testBrand = {
  name: 'Test Automation Brand',
  id: 'test_automation_brand',
  tagline: 'AI-Generated Books for Modern Learners',
  themeColor: '#6366F1',
  accentColor: '#EC4899',
  HERO_HEADLINE: 'Master Any Topic with AI-Powered Learning',
  HERO_SUBHEADLINE: 'Comprehensive guides generated by advanced AI',
  BUTTON_TEXT: 'Explore Books',
  features: {
    newsletter: true,
    reviews: true,
    socialSharing: true
  }
};

const testBook = {
  brandId: 'test_automation_brand',
  book: {
    id: 'test_book_1',
    title: 'Introduction to Quantum Computing',
    author: 'AI Assistant',
    price: 14.99,
    salePrice: 9.99,
    description: 'Learn quantum computing fundamentals in plain English.',
    longDescription: 'A comprehensive introduction to quantum computing designed for beginners. This book covers qubits, superposition, entanglement, and quantum algorithms without requiring advanced mathematics.',
    categories: ['Technology', 'Science'],
    tags: ['quantum', 'computing', 'physics', 'technology'],
    wordCount: 45000,
    chapters: [
      { number: 1, title: 'What is Quantum Computing?' },
      { number: 2, title: 'Understanding Qubits' },
      { number: 3, title: 'Quantum Gates and Circuits' },
      { number: 4, title: 'Quantum Algorithms' },
      { number: 5, title: 'The Future of Quantum Computing' }
    ],
    features: [
      'Clear explanations for beginners',
      'Real-world examples',
      'Hands-on exercises',
      'No advanced math required'
    ]
  }
  // Note: In real implementation, coverFile and pdfFile would be base64-encoded file data
};

const testSEOPost = {
  brandId: 'test_automation_brand',
  post: {
    slug: 'what-is-quantum-computing',
    title: 'What is Quantum Computing? A Beginner\'s Guide',
    metaDescription: 'Learn the fundamentals of quantum computing in this comprehensive beginner\'s guide. Understand qubits, superposition, and why quantum computers matter.',
    keywords: 'quantum computing, qubits, quantum mechanics, technology',
    content: `
      <h2>Introduction to Quantum Computing</h2>
      <p>Quantum computing represents a revolutionary approach to computation that leverages the principles of quantum mechanics to solve problems that are intractable for classical computers.</p>

      <h3>What Makes Quantum Computers Different?</h3>
      <p>Unlike classical computers that use bits (0 or 1), quantum computers use quantum bits or "qubits" that can exist in superposition - simultaneously representing both 0 and 1.</p>

      <h3>Key Concepts</h3>
      <ul>
        <li><strong>Superposition:</strong> The ability of qubits to be in multiple states at once</li>
        <li><strong>Entanglement:</strong> Quantum correlation between qubits</li>
        <li><strong>Quantum Gates:</strong> Operations that manipulate qubit states</li>
      </ul>

      <h3>Real-World Applications</h3>
      <p>Quantum computers are being developed to solve problems in:</p>
      <ul>
        <li>Drug discovery and molecular simulation</li>
        <li>Cryptography and cybersecurity</li>
        <li>Financial modeling and optimization</li>
        <li>Artificial intelligence and machine learning</li>
      </ul>

      <h3>Learn More</h3>
      <p>Want to dive deeper into quantum computing? Check out our comprehensive guide that covers everything from basic concepts to advanced algorithms.</p>
    `,
    relatedBook: true
  }
};

// Test functions
async function testBrandCreation() {
  console.log('\nðŸ“¦ Testing Brand Creation Webhook...\n');

  try {
    const response = await fetch(`${BASE_URL}/webhooks/orchestrator/brand-created`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(testBrand)
    });

    const data = await response.json();

    if (response.ok) {
      console.log('âœ… Brand created successfully!');
      console.log(`   Brand ID: ${data.brandId}`);
      console.log(`   URL: ${data.url}`);
      console.log(`   Directories created:`);
      console.log(`     - ${data.directories.brand}`);
      console.log(`     - ${data.directories.covers}`);
      console.log(`     - ${data.directories.books}`);
      console.log(`     - ${data.directories.blog}`);
      return true;
    } else {
      console.log('âŒ Brand creation failed');
      console.log(`   Error: ${data.error}`);
      return false;
    }
  } catch (error) {
    console.log('âŒ Request failed');
    console.log(`   Error: ${error.message}`);
    return false;
  }
}

async function testBookGeneration() {
  console.log('\nðŸ“š Testing Book Generation Webhook...\n');

  try {
    const response = await fetch(`${BASE_URL}/webhooks/orchestrator/book-generated`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(testBook)
    });

    const data = await response.json();

    if (response.ok) {
      console.log('âœ… Book added successfully!');
      console.log(`   Book ID: ${data.bookId}`);
      console.log(`   Brand URL: ${data.brandUrl}`);
      console.log(`   Catalog size: ${data.catalogSize} books`);
      return true;
    } else {
      console.log('âŒ Book generation failed');
      console.log(`   Error: ${data.error}`);
      return false;
    }
  } catch (error) {
    console.log('âŒ Request failed');
    console.log(`   Error: ${error.message}`);
    return false;
  }
}

async function testSEOGeneration() {
  console.log('\nðŸ“ Testing SEO Content Webhook...\n');

  try {
    const response = await fetch(`${BASE_URL}/webhooks/orchestrator/seo-generated`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(testSEOPost)
    });

    const data = await response.json();

    if (response.ok) {
      console.log('âœ… Blog post published successfully!');
      console.log(`   Post URL: ${data.postUrl}`);
      console.log(`   Slug: ${data.slug}`);
      return true;
    } else {
      console.log('âŒ SEO generation failed');
      console.log(`   Error: ${data.error}`);
      return false;
    }
  } catch (error) {
    console.log('âŒ Request failed');
    console.log(`   Error: ${error.message}`);
    return false;
  }
}

async function testHealthCheck() {
  console.log('\nðŸ¥ Testing Webhook Health Endpoint...\n');

  try {
    const response = await fetch(`${BASE_URL}/webhooks/health`);
    const data = await response.json();

    if (response.ok && data.status === 'ok') {
      console.log('âœ… Webhooks are healthy!');
      console.log('   Available endpoints:');
      data.webhooks.forEach(webhook => {
        console.log(`     - ${webhook}`);
      });
      return true;
    } else {
      console.log('âŒ Health check failed');
      return false;
    }
  } catch (error) {
    console.log('âŒ Health check failed');
    console.log(`   Error: ${error.message}`);
    return false;
  }
}

// Run all tests
async function runTests() {
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('  WEBHOOK INTEGRATION TEST SUITE');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log(`  Server: ${BASE_URL}`);
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

  const results = {
    health: await testHealthCheck(),
    brandCreation: await testBrandCreation(),
    bookGeneration: await testBookGeneration(),
    seoGeneration: await testSEOGeneration()
  };

  console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('  TEST RESULTS');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log(`  Health Check:       ${results.health ? 'âœ… PASS' : 'âŒ FAIL'}`);
  console.log(`  Brand Creation:     ${results.brandCreation ? 'âœ… PASS' : 'âŒ FAIL'}`);
  console.log(`  Book Generation:    ${results.bookGeneration ? 'âœ… PASS' : 'âŒ FAIL'}`);
  console.log(`  SEO Generation:     ${results.seoGeneration ? 'âœ… PASS' : 'âŒ FAIL'}`);
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

  const allPassed = Object.values(results).every(result => result);

  if (allPassed) {
    console.log('\nðŸŽ‰ All tests passed! Webhook integration is working.\n');
    console.log('Next steps:');
    console.log('1. View the test brand: http://localhost:3001/store.html?brand=test_automation_brand');
    console.log('2. Implement orchestrator client code to call these webhooks');
    console.log('3. Test end-to-end flow: orchestrator â†’ webhooks â†’ marketplace\n');
  } else {
    console.log('\nâš ï¸  Some tests failed. Check the server logs for details.\n');
  }

  process.exit(allPassed ? 0 : 1);
}

// Check if server is running
async function checkServer() {
  try {
    const response = await fetch(`${BASE_URL}/api/health`);
    if (response.ok) {
      return true;
    }
  } catch (error) {
    console.log('\nâŒ Server is not running at', BASE_URL);
    console.log('   Please start the server first:');
    console.log('   cd marketplace/backend && npm start\n');
    return false;
  }
}

// Main execution
(async () => {
  const serverRunning = await checkServer();
  if (serverRunning) {
    await runTests();
  } else {
    process.exit(1);
  }
})();
