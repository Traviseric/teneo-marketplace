#!/usr/bin/env node
/**
 * Import Brand from OrchestratorOS
 *
 * This script bridges the orchestrator and marketplace:
 * 1. Reads BRAND_CONFIG.json from orchestrator output
 * 2. Creates marketplace brand directory structure
 * 3. Generates config.json, catalog.json, variables.json
 * 4. Saves to marketplace/frontend/brands/
 *
 * Usage:
 *   node scripts/import-orchestrator-brand.js
 *   node scripts/import-orchestrator-brand.js --config path/to/BRAND_CONFIG.json
 */

const fs = require('fs');
const path = require('path');

// Configuration
const ORCHESTRATOR_DIR = path.join(__dirname, '../../orchestrator');
const MARKETPLACE_BRANDS_DIR = path.join(__dirname, '../marketplace/frontend/brands');
const DEFAULT_ORCHESTRATOR_CONFIG = path.join(ORCHESTRATOR_DIR, 'marketplace_coordination/BRAND_CONFIG.json');

/**
 * Convert orchestrator color format to marketplace format
 */
function convertColor(hex) {
  // Orchestrator uses #4F46E5, marketplace needs same format
  return hex;
}

/**
 * Generate brand ID from brand name
 */
function generateBrandId(brandName) {
  return brandName
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '_')
    .replace(/^_+|_+$/g, '');
}

/**
 * Convert orchestrator BRAND_CONFIG to marketplace config.json
 */
function generateMarketplaceConfig(orchestratorConfig) {
  const brandId = generateBrandId(orchestratorConfig.BRAND_NAME);

  return {
    id: brandId,
    name: orchestratorConfig.BRAND_NAME,
    tagline: orchestratorConfig.HERO_SUBHEADLINE,
    emoji: "üìö", // Default, can be customized later
    description: orchestratorConfig.unique_selling_proposition,

    // Colors from orchestrator
    themeColor: orchestratorConfig.PRIMARY_COLOR,
    accentColor: orchestratorConfig.ACCENT_COLOR,

    // Features
    features: {
      cryptoPayments: true,
      networkFederation: true,
      printOnDemand: false // Can be enabled later
    },

    // Payment methods
    paymentMethods: {
      stripe: true,
      crypto: true
    },

    // Brand guidelines from orchestrator
    brand_voice: orchestratorConfig.brand_voice,
    brand_guidelines: orchestratorConfig.brand_guidelines,

    // Metadata
    created_by: "orchestrator",
    orchestrator_quality_score: orchestratorConfig.quality_score,
    created_at: new Date().toISOString()
  };
}

/**
 * Generate marketplace catalog.json
 */
function generateMarketplaceCatalog(orchestratorConfig) {
  return {
    books: [
      // Placeholder - books will be added by Book Creation Agent
      {
        id: "placeholder_001",
        title: "Coming Soon",
        author: "AI Generated",
        price: 0,
        description: "Books are being generated by the orchestrator...",
        tags: ["placeholder"],
        featured: false,
        status: "generating"
      }
    ]
  };
}

/**
 * Generate marketplace variables.json
 */
function generateMarketplaceVariables(orchestratorConfig) {
  return {
    heroHeadline: orchestratorConfig.HERO_HEADLINE,
    heroSubheadline: orchestratorConfig.HERO_SUBHEADLINE,
    ctaButtonText: orchestratorConfig.BUTTON_TEXT,

    features: orchestratorConfig.features.map(f => ({
      title: f.title,
      description: f.description
    })),

    socialProof: {
      headline: orchestratorConfig.social_proof.headline,
      testimonials: orchestratorConfig.social_proof.testimonials
    },

    faq: orchestratorConfig.faq
  };
}

/**
 * Create brand directory structure in marketplace
 */
function createBrandDirectory(brandId, orchestratorConfig) {
  const brandDir = path.join(MARKETPLACE_BRANDS_DIR, brandId);

  // Create directory if it doesn't exist
  if (!fs.existsSync(brandDir)) {
    fs.mkdirSync(brandDir, { recursive: true });
    console.log(`‚úì Created brand directory: ${brandDir}`);
  } else {
    console.log(`‚ö†Ô∏è  Brand directory already exists: ${brandDir}`);
    const answer = require('readline-sync').question('Overwrite? (y/n): ');
    if (answer.toLowerCase() !== 'y') {
      console.log('Aborted.');
      process.exit(0);
    }
  }

  // Generate marketplace files
  const config = generateMarketplaceConfig(orchestratorConfig);
  const catalog = generateMarketplaceCatalog(orchestratorConfig);
  const variables = generateMarketplaceVariables(orchestratorConfig);

  // Write files
  fs.writeFileSync(
    path.join(brandDir, 'config.json'),
    JSON.stringify(config, null, 2)
  );
  console.log(`‚úì Created config.json`);

  fs.writeFileSync(
    path.join(brandDir, 'catalog.json'),
    JSON.stringify(catalog, null, 2)
  );
  console.log(`‚úì Created catalog.json`);

  fs.writeFileSync(
    path.join(brandDir, 'variables.json'),
    JSON.stringify(variables, null, 2)
  );
  console.log(`‚úì Created variables.json`);

  return brandId;
}

/**
 * Generate summary report
 */
function generateReport(brandId, orchestratorConfig, config) {
  console.log('\n' + '='.repeat(60));
  console.log('BRAND IMPORT COMPLETE');
  console.log('='.repeat(60));
  console.log(`\nBrand Name: ${orchestratorConfig.BRAND_NAME}`);
  console.log(`Brand ID: ${brandId}`);
  console.log(`Quality Score: ${orchestratorConfig.quality_score}/10`);
  console.log(`\nColors:`);
  console.log(`  Primary: ${orchestratorConfig.PRIMARY_COLOR}`);
  console.log(`  Accent: ${orchestratorConfig.ACCENT_COLOR}`);
  console.log(`\nLocation: marketplace/frontend/brands/${brandId}/`);
  console.log(`\nFiles Created:`);
  console.log(`  ‚úì config.json`);
  console.log(`  ‚úì catalog.json`);
  console.log(`  ‚úì variables.json`);
  console.log(`\nNext Steps:`);
  console.log(`  1. Run orchestrator Book Creation Agent to generate books`);
  console.log(`  2. Import books: node scripts/import-orchestrator-books.js ${brandId}`);
  console.log(`  3. Start marketplace: npm start`);
  console.log(`  4. Visit: http://localhost:3001/store.html?brand=${brandId}`);
  console.log('\n' + '='.repeat(60));
}

/**
 * Main execution
 */
function main() {
  console.log('üöÄ OrchestratorOS ‚Üí Marketplace Brand Import\n');

  // Parse command line arguments
  const configPath = process.argv.includes('--config')
    ? process.argv[process.argv.indexOf('--config') + 1]
    : DEFAULT_ORCHESTRATOR_CONFIG;

  // Check if orchestrator config exists
  if (!fs.existsSync(configPath)) {
    console.error(`‚ùå Error: BRAND_CONFIG.json not found at ${configPath}`);
    console.error('\nMake sure to run the orchestrator first:');
    console.error('  cd ../orchestrator');
    console.error('  python src/orchestrator/marketplace/agents/brand_strategist_agent.py');
    process.exit(1);
  }

  // Read orchestrator config
  console.log(`Reading orchestrator config from:\n  ${configPath}\n`);
  const orchestratorConfig = JSON.parse(fs.readFileSync(configPath, 'utf8'));

  // Create brand in marketplace
  console.log('Creating brand in marketplace...\n');
  const brandId = createBrandDirectory(
    generateBrandId(orchestratorConfig.BRAND_NAME),
    orchestratorConfig
  );

  // Generate report
  const config = generateMarketplaceConfig(orchestratorConfig);
  generateReport(brandId, orchestratorConfig, config);
}

// Run if called directly
if (require.main === module) {
  main();
}

module.exports = {
  generateBrandId,
  generateMarketplaceConfig,
  generateMarketplaceCatalog,
  generateMarketplaceVariables
};
